<html>
<head>
	<script src="eaas/resources/js/jquery.js"></script>
	
	<script src="eaas/resources/js/bwfla.pointerlock.js" ></script>
	<script src="eaas/resources/js/bwfla.eventhandler.js" ></script>
	<script src="eaas/resources/js/bwfla.mouse.js" ></script>
	<script src="eaas/resources/js/screenfull.min.js" ></script>
	<script src="eaas/resources/guacamole/ArrayBufferReader.js" ></script>
	<script src="eaas/resources/guacamole/ArrayBufferWriter.js" ></script>
	<script src="eaas/resources/guacamole/AudioChannel.js" ></script>
	<script src="eaas/resources/guacamole/BlobReader.js" ></script>
	<script src="eaas/resources/guacamole/Client.js"></script>
	<script src="eaas/resources/guacamole/Display.js"></script>
	<script src="eaas/resources/guacamole/InputStream.js" ></script>
	<script src="eaas/resources/guacamole/IntegerPool.js" ></script>
	<script src="eaas/resources/guacamole/Keyboard.js" ></script>
	<script src="eaas/resources/guacamole/Layer.js" ></script>
	<script src="eaas/resources/guacamole/Mouse.js"></script>
	<script src="eaas/resources/guacamole/OnScreenKeyboard.js" ></script>
	<script src="eaas/resources/guacamole/OutputStream.js" ></script>
	<script src="eaas/resources/guacamole/Parser.js" ></script>
	<script src="eaas/resources/guacamole/Status.js" ></script>
	<script src="eaas/resources/guacamole/StringReader.js" ></script>
	<script src="eaas/resources/guacamole/StringWriter.js" ></script>
	<script src="eaas/resources/guacamole/Tunnel.js" ></script>
	
	<link rel="stylesheet" type="text/css" href="eaas/resources/css/keyboard.css" ></link>

	<style>
	body {
		margin: 0px;
	}
	
	.display {
		position: absolute;
	}
	</style>

	<script>
	$.urlParam = function(url, name){
	    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(url);
	    if (results==null){
	       return null;
	    }
	    else{
	       return decodeURI(results[1]) || 0;
	    }
	};




	
	function establishGuacamoleTunnel(tunnelUrl) {
        window.onbeforeunload = function()
        {
            guac.disconnect();
        }
       
        /*setInterval(function(){$('#display').css({'left': -$('#display').width()/2, 'top': -$('#display').height()/2});}, 1000);*/
        
        $.fn.focusWithoutScrolling = function()
        {
            var x = window.scrollX, y = window.scrollY;
            this.focus();
            window.scrollTo(x, y);
        };
          
       
		var guac = new Guacamole.Client(new Guacamole.HTTPTunnel(tunnelUrl));
		var displayElement = guac.getDisplay().getElement();
		
		BWFLA.hideClientCursor(guac);
		$('#display').prepend(displayElement);

		function onIFrameResize(width, height) 
		{
			var target = window.parent;
			var origin = (window.location != window.parent.location) ? document.referrer: document.location;
			var message = { opcode: "resize", w: width, h: height };
			target.postMessage(message, "*"/*origin*/);
		};
		
		BWFLA.registerEventCallback(guac.getDisplay(), 'resize', onIFrameResize);
		guac.connect(); 
		
		window.addEventListener("message", function(event) {
			// any messeage will cause a fullscreen event for now
			screenfull.request(displayElement);	
		});
	
		var mouse = new Guacamole.Mouse(displayElement);
		var touch = new Guacamole.Mouse.Touchpad(displayElement);
		var mousefix = new BwflaMouse(guac);
	   
		//touch.onmousedown = touch.onmouseup = touch.onmousemove =
		//mouse.onmousedown = mouse.onmouseup = mouse.onmousemove = 
		//function(mouseState) { guac.sendMouseState(mouseState); };
		
		mouse.onmousedown = touch.onmousedown = mousefix.onmousedown;
		mouse.onmouseup = touch.onmouseup = mousefix.onmouseup;
		mouse.onmousemove = touch.onmousemove = mousefix.onmousemove;
		
		var keyboard = new Guacamole.Keyboard(displayElement);
		
		keyboard.onkeydown = function (keysym) { guac.sendKeyEvent(1, keysym); };
		keyboard.onkeyup = function (keysym) { guac.sendKeyEvent(0, keysym); };
		
		$(displayElement).attr('tabindex', '0');
		$(displayElement).css('outline', '0');
		$(displayElement).mouseenter(function() {$(this).focusWithoutScrolling();});
		
		/*
		oskeyboard = new Guacamole.OnScreenKeyboard("/emucomp/resources/layouts/en-us-qwerty.xml");
		
		$('#keyboard-wrapper').addClass('keyboard-container');
		$('#keyboard-wrapper').html(oskeyboard.getElement());
		
		function resizeKeyboardTimer()
		{                                           
		    oskeyboard.resize($('#display > div').width()*0.95);
		    setTimeout(resizeKeyboardTimer, 200);
		}
		
		resizeKeyboardTimer();
		
		oskeyboard.onkeydown = function (keysym) { guac.sendKeyEvent(1, keysym); };
		oskeyboard.onkeyup = function (keysym) { guac.sendKeyEvent(0, keysym); };
		*/
	}

	function pollState(controlurl) {
		
		
		$.get(controlurl + "/state")
		.done(function (data) {
			if (data.state == "running") {
				establishGuacamoleTunnel(controlurl + "/tunnel");
			} else {
				setTimeout(pollState, 1000, controlurl);
			}
		});
	}
	//pollState();

	//if ($.urlParam("pointerLock") !== null) {
    //	BWFLA.requestPointerLock(displayElement, 'click');
	//}

	var controlurl = decodeURIComponent($.urlParam(window.location, "controlurl"));
	pollState(controlurl);
	
	var componentId = $.urlParam(controlurl, "componentId");

	var getLocation = function(href) {
	    var l = document.createElement("a");
	    l.href = href;
	    return l;
	};


	


	
	</script>
	
</head>

<body>
	<div id="display" class="display" align="center" style="cursor: url(eaas/resources/images/transcursor.png) 1 4, auto !important;" />
</body>
</html>
